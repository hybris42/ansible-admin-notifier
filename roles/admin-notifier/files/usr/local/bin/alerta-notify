#! /bin/bash

source /etc/default/admin-notifier

if [ -z "${ALERTA_URL}" ] || [ -z "${ALERTA_KEY}" ]; then
  echo "error: you should define ALERTA_URL and ALERTA_KEY in /etc/default/alerta"
  exit 1
fi

if [ -z "${ALERTA_HOST}" ]; then
     ALERTA_HOST=$(echo ${ALERTA_URL} | sed 's|.*://||')
fi

if [ $# -ne 5 ]; then
  echo "usage: alerta-notify ENVIRONMENT EVENT RESOURCE SERVICE MESSAGE"
  exit 1
fi

ENVIRONMENT=$1
EVENT=$2
RESOURCE=$3
SERVICE=$4
MESSAGE=$(echo "$5" | tr '\n' ' ')

case ${EVENT} in
    heartbeat)
        curl -s -X POST ${ALERTA_URL}/api/heartbeat \
             -H "Host: ${ALERTA_HOST}" \
             -H "Authorization: Key ${ALERTA_KEY}" \
             -H "Content-type: application/json" \
             -d "{
                     \"origin\": \"${RESOURCE}\",
                     \"timeout\": 180,
                     \"attributes\": {
                         \"environment\": \"${ENVIRONMENT}\",
                         \"event\": \"Ping\",
                         \"service\": [\"os\"],
                         \"runBookUrl\": \"<a href=\\\"${ALERTA_EXTERNAL_URL}Heartbeat\\\" target=\\\"_blank\\\">Heartbeat</a>\"
                     }
                 }" >> /var/log/admin-notifier/alerta.log
        ;;
    *OK)
        curl -s -X POST ${ALERTA_URL}/api/alert \
             -H "Host: ${ALERTA_HOST}" \
             -H "Authorization: Key ${ALERTA_KEY}" \
             -H "Content-type: application/json" \
             -d "{
                     \"environment\": \"${ENVIRONMENT}\",
                     \"event\": \"${EVENT:0: -2}\",
                     \"resource\": \"${RESOURCE}\",
                     \"service\": [\"${SERVICE}\"],
                     \"status\": \"closed\",
                     \"text\": \"${MESSAGE}\",
                     \"attributes\": {
                         \"runBookUrl\": \"<a href=\\\"${ALERTA_EXTERNAL_URL}${EVENT:0: -2}\\\" target=\\\"_blank\\\">${EVENT:0: -2}</a>\"
                     }
                 }" >> /var/log/admin-notifier/alerta.log
        ;;
    *)
        curl -s -X POST ${ALERTA_URL}/api/alert \
             -H "Host: ${ALERTA_HOST}" \
             -H "Authorization: Key ${ALERTA_KEY}" \
             -H "Content-type: application/json" \
             -d "{
                     \"environment\": \"${ENVIRONMENT}\",
                     \"event\": \"${EVENT}\",
                     \"resource\": \"${RESOURCE}\",
                     \"service\": [\"${SERVICE}\"],
                     \"severity\": \"major\",
                     \"text\": \"${MESSAGE}\",
                     \"value\": \"${MESSAGE}\",
                     \"attributes\": {
                         \"runBookUrl\": \"<a href=\\\"${ALERTA_EXTERNAL_URL}${EVENT}\\\" target=\\\"_blank\\\">${EVENT}</a>\"
                     }
                 }" >> /var/log/admin-notifier/alerta.log
        ;;
esac
